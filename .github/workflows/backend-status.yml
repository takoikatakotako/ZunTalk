name: Backend Deploy Status

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY_BACKEND: zuntalk-backend
  ECR_REPOSITORY_SLACK_NOTIFIER: zuntalk-slack-notifier
  SHARED_ACCOUNT_ID: "448049807848"
  DEV_ACCOUNT_ID: "039612872248"
  PROD_ACCOUNT_ID: "986921280333"

jobs:
  status:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials (Dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.DEV_ACCOUNT_ID }}:role/zuntalk-dev-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: List available images in ECR
        run: |
          set -euo pipefail

          echo "## ðŸ“¦ Available Images in ECR" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### zuntalk-backend (latest 20)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Pushed At | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|------|" >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images \
            --registry-id $SHARED_ACCOUNT_ID \
            --repository-name $ECR_REPOSITORY_BACKEND \
            --query 'sort_by(imageDetails, &imagePushedAt) | reverse(@) | [0:20]' \
            --output json | jq -r '.[] | "| `\(.imageTags // ["untagged"] | join(", "))` | \(.imagePushedAt | split(".")[0]) | \((.imageSizeInBytes / 1024 / 1024) | floor)MB |"' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### zuntalk-slack-notifier (latest 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Pushed At | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|------|" >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images \
            --registry-id $SHARED_ACCOUNT_ID \
            --repository-name $ECR_REPOSITORY_SLACK_NOTIFIER \
            --query 'sort_by(imageDetails, &imagePushedAt) | reverse(@) | [0:5]' \
            --output json | jq -r '.[] | "| `\(.imageTags // ["untagged"] | join(", "))` | \(.imagePushedAt | split(".")[0]) | \((.imageSizeInBytes / 1024 / 1024) | floor)MB |"' >> $GITHUB_STEP_SUMMARY

      - name: Get Dev deployed image (backend)
        id: dev-backend
        run: |
          set -euo pipefail
          IMAGE=$(aws lambda get-function --function-name zuntalk-backend-dev --query 'Code.ImageUri' --output text)
          TAG=$(echo $IMAGE | sed 's/.*://')
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Get Dev deployed image (slack-notifier)
        id: dev-slack-notifier
        run: |
          set -euo pipefail
          IMAGE=$(aws lambda get-function --function-name zuntalk-slack-notifier-dev --query 'Code.ImageUri' --output text)
          TAG=$(echo $IMAGE | sed 's/.*://')
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (Prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.PROD_ACCOUNT_ID }}:role/zuntalk-prod-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Prod deployed image (backend)
        id: prod-backend
        run: |
          set -euo pipefail
          IMAGE=$(aws lambda get-function --function-name zuntalk-backend-prod --query 'Code.ImageUri' --output text)
          TAG=$(echo $IMAGE | sed 's/.*://')
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Get Prod deployed image (slack-notifier)
        id: prod-slack-notifier
        run: |
          set -euo pipefail
          IMAGE=$(aws lambda get-function --function-name zuntalk-slack-notifier-prod --query 'Code.ImageUri' --output text)
          TAG=$(echo $IMAGE | sed 's/.*://')
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Currently Deployed Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### zuntalk-backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Env | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | \`${{ steps.dev-backend.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | \`${{ steps.prod-backend.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dev-backend.outputs.tag }}" = "${{ steps.prod-backend.outputs.tag }}" ]; then
            echo "âœ… Dev and Prod are running the same image" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Dev and Prod are running different images" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### zuntalk-slack-notifier" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Env | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | \`${{ steps.dev-slack-notifier.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | \`${{ steps.prod-slack-notifier.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dev-slack-notifier.outputs.tag }}" = "${{ steps.prod-slack-notifier.outputs.tag }}" ]; then
            echo "âœ… Dev and Prod are running the same image" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Dev and Prod are running different images" >> $GITHUB_STEP_SUMMARY
          fi
