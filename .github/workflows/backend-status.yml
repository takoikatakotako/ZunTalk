name: Backend Deploy Status

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY_BACKEND: zuntalk-backend
  ECR_REPOSITORY_SLACK_NOTIFIER: zuntalk-slack-notifier
  SHARED_ACCOUNT_ID: "448049807848"
  DEV_ACCOUNT_ID: "039612872248"
  PROD_ACCOUNT_ID: "986921280333"

jobs:
  status:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials (Dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.DEV_ACCOUNT_ID }}:role/zuntalk-dev-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Dev deployed image
        id: dev-image
        run: |
          set -euo pipefail
          DEV_IMAGE=$(aws lambda get-function --function-name zuntalk-backend-dev --query 'Code.ImageUri' --output text)
          DEV_TAG=$(echo $DEV_IMAGE | sed 's/.*://')
          echo "image=$DEV_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$DEV_TAG" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (Prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.PROD_ACCOUNT_ID }}:role/zuntalk-prod-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Prod deployed image
        id: prod-image
        run: |
          set -euo pipefail
          PROD_IMAGE=$(aws lambda get-function --function-name zuntalk-backend-prod --query 'Code.ImageUri' --output text)
          PROD_TAG=$(echo $PROD_IMAGE | sed 's/.*://')
          echo "image=$PROD_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$PROD_TAG" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "## ðŸš€ Currently Deployed Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Dev (zuntalk-backend-dev)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URI**: \`${{ steps.dev-image.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.dev-image.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Prod (zuntalk-backend-prod)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URI**: \`${{ steps.prod-image.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.prod-image.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dev-image.outputs.tag }}" = "${{ steps.prod-image.outputs.tag }}" ]; then
            echo "âœ… Dev and Prod are running the same image" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Dev and Prod are running different images" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Configure AWS credentials (Dev - for ECR)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.DEV_ACCOUNT_ID }}:role/zuntalk-dev-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: List available images in ECR
        run: |
          set -euo pipefail

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Available Images in ECR" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### zuntalk-backend (latest 20)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Pushed At | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|------|" >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images \
            --registry-id $SHARED_ACCOUNT_ID \
            --repository-name $ECR_REPOSITORY_BACKEND \
            --query 'sort_by(imageDetails, &imagePushedAt) | reverse(@) | [0:20]' \
            --output json | jq -r '.[] | "| `\(.imageTags[0] // "untagged")` | \(.imagePushedAt | split(".")[0]) | \((.imageSizeInBytes / 1024 / 1024) | floor)MB |"' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### zuntalk-slack-notifier (latest 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Pushed At | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|------|" >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images \
            --registry-id $SHARED_ACCOUNT_ID \
            --repository-name $ECR_REPOSITORY_SLACK_NOTIFIER \
            --query 'sort_by(imageDetails, &imagePushedAt) | reverse(@) | [0:5]' \
            --output json | jq -r '.[] | "| `\(.imageTags[0] // "untagged")` | \(.imagePushedAt | split(".")[0]) | \((.imageSizeInBytes / 1024 / 1024) | floor)MB |"' >> $GITHUB_STEP_SUMMARY
